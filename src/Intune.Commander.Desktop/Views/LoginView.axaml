<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Intune.Commander.Desktop.ViewModels"
             xmlns:suki="https://github.com/kikipoulet/SukiUI"
             xmlns:mi="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
             x:Class="Intune.Commander.Desktop.Views.LoginView"
             x:DataType="vm:LoginViewModel">

    <Design.DataContext>
        <vm:LoginViewModel />
    </Design.DataContext>

    <Grid ColumnDefinitions="*,*">
        
        <!-- Left Side: Branding & Welcome -->
        <Border Grid.Column="0" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="24" Margin="40">
                <Border CornerRadius="100" ClipToBounds="True" Width="160" Height="160" HorizontalAlignment="Center"
                        BorderBrush="{DynamicResource SystemControlBackgroundChromeMediumBrush}" BorderThickness="4">
                    <Image Source="avares://Intune.Commander.Desktop/Assets/logo.png" 
                           Width="160" Height="160" Stretch="UniformToFill" />
                </Border>
                <StackPanel Spacing="8">
                    <TextBlock Text="Intune Commander"
                               FontSize="42" FontWeight="Bold"
                               Foreground="{StaticResource TextGradientBrush}"
                               HorizontalAlignment="Center" />
                    <TextBlock Text="The ultimate desktop client for Microsoft Intune."
                               FontSize="{StaticResource FontSizeHeading}"
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource AppTextSecondaryBrush}"
                               TextWrapping="Wrap" TextAlignment="Center" />
                </StackPanel>
                
                <StackPanel Spacing="12" Margin="0,32,0,0" MaxWidth="300">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <mi:MaterialIcon Kind="ViewDashboard" Width="24" Height="24" Foreground="{DynamicResource SystemControlForegroundAccentBrush}" />
                        <TextBlock Text="Lightning fast native performance" VerticalAlignment="Center" FontSize="{StaticResource FontSizeSubheading}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <mi:MaterialIcon Kind="ShieldKey" Width="24" Height="24" Foreground="{DynamicResource SystemControlForegroundAccentBrush}" />
                        <TextBlock Text="Multi-cloud &amp; multi-tenant support" VerticalAlignment="Center" FontSize="{StaticResource FontSizeSubheading}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <mi:MaterialIcon Kind="FileDocumentOutline" Width="24" Height="24" Foreground="{DynamicResource SystemControlForegroundAccentBrush}" />
                        <TextBlock Text="Bulk export and reporting" VerticalAlignment="Center" FontSize="{StaticResource FontSizeSubheading}" />
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Right Side: Login Form -->
        <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <StackPanel Spacing="12" MaxWidth="480" Margin="40,16" HorizontalAlignment="Center" VerticalAlignment="Center">

                <StackPanel Spacing="2">
                    <TextBlock Text="Connect to Tenant" FontSize="28" FontWeight="Bold" />
                    <TextBlock Text="Select a saved profile or enter your credentials below." 
                               FontSize="{StaticResource FontSizeSubheading}" 
                               Foreground="{DynamicResource AppTextSecondaryBrush}" />
                </StackPanel>

                <suki:GlassCard Padding="16">
                    <StackPanel Spacing="8">
                        
                        <!-- Saved Profiles -->
                        <StackPanel Spacing="2">
                            <TextBlock Text="Saved Profiles" FontSize="{StaticResource FontSizeBody}" FontWeight="SemiBold" />
                            <Grid ColumnDefinitions="*,Auto,Auto,Auto">
                                <ComboBox Grid.Column="0" ItemsSource="{Binding SavedProfiles}"
                                          SelectedItem="{Binding SelectedProfile}"
                                          HorizontalAlignment="Stretch"
                                          PlaceholderText="Select a profile or create new..."
                                          IsEnabled="{Binding !IsBusy}">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Name}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <Button Grid.Column="1" Command="{Binding ClearProfileCommand}" 
                                        Classes="Basic" Margin="8,0,0,0" ToolTip.Tip="New Profile"
                                        IsEnabled="{Binding !IsBusy}">
                                    <mi:MaterialIcon Kind="Plus" Width="20" Height="20" />
                                </Button>
                                <Button Grid.Column="2" Command="{Binding ImportProfilesCommand}" 
                                        Classes="Basic" Margin="8,0,0,0" ToolTip.Tip="Import Profiles"
                                        IsEnabled="{Binding !IsBusy}">
                                    <mi:MaterialIcon Kind="FileImportOutline" Width="20" Height="20" />
                                </Button>
                                <Button Grid.Column="3" Command="{Binding DeleteProfileCommand}" 
                                        Classes="Basic" Margin="8,0,0,0" ToolTip.Tip="Delete Profile"
                                        IsEnabled="{Binding SelectedProfile, Converter={x:Static ObjectConverters.IsNotNull}}">
                                    <mi:MaterialIcon Kind="TrashCanOutline" Width="20" Height="20" />
                                </Button>
                            </Grid>
                        </StackPanel>

                        <Separator Margin="0,2" Opacity="0.5" />

                        <!-- Profile Name & Tenant ID side by side -->
                        <Grid ColumnDefinitions="*,12,*">
                            <StackPanel Spacing="2" Grid.Column="0">
                                <TextBlock Text="Profile Name (optional)" FontSize="{StaticResource FontSizeBody}" FontWeight="SemiBold" />
                                <TextBox Text="{Binding ProfileName}"
                                         Watermark="e.g. Contoso-Prod"
                                         IsEnabled="{Binding !IsBusy}" />
                            </StackPanel>
                            <StackPanel Spacing="2" Grid.Column="2">
                                <TextBlock Text="Tenant ID" FontSize="{StaticResource FontSizeBody}" FontWeight="SemiBold" />
                                <TextBox Text="{Binding TenantId}"
                                         Watermark="xxxx-xxxx-xxxx-xxxx"
                                         IsEnabled="{Binding !IsBusy}" />
                                <TextBlock Text="{Binding TenantIdError}"
                                           Foreground="{DynamicResource AppErrorTextBrush}" FontSize="{StaticResource FontSizeCaption}"
                                           IsVisible="{Binding TenantIdError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                            </StackPanel>
                        </Grid>

                        <!-- Cloud Environment + Auth Method side by side -->
                        <Grid ColumnDefinitions="*,12,*">
                            <StackPanel Spacing="2" Grid.Column="0">
                                <TextBlock Text="Cloud Environment" FontSize="{StaticResource FontSizeBody}" FontWeight="SemiBold" />
                                <ComboBox ItemsSource="{Binding AvailableClouds}"
                                          SelectedItem="{Binding SelectedCloud}"
                                          HorizontalAlignment="Stretch"
                                          IsEnabled="{Binding !IsBusy}" />
                            </StackPanel>
                            <StackPanel Spacing="2" Grid.Column="2">
                                <TextBlock Text="Auth Method" FontSize="{StaticResource FontSizeBody}" FontWeight="SemiBold" />
                                <ComboBox ItemsSource="{Binding AvailableAuthMethods}"
                                          SelectedItem="{Binding SelectedAuthMethod}"
                                          HorizontalAlignment="Stretch"
                                          IsEnabled="{Binding !IsBusy}" />
                            </StackPanel>
                        </Grid>

                        <!-- Client ID & Client Secret side by side -->
                        <Grid ColumnDefinitions="*,12,*">
                            <StackPanel Spacing="2" Grid.Column="0">
                                <TextBlock Text="Client ID (App Reg)" FontSize="{StaticResource FontSizeBody}" FontWeight="SemiBold" />
                                <TextBox Text="{Binding ClientId}"
                                         Watermark="xxxx-xxxx-xxxx-xxxx"
                                         IsEnabled="{Binding !IsBusy}" />
                                <TextBlock Text="{Binding ClientIdError}"
                                           Foreground="{DynamicResource AppErrorTextBrush}" FontSize="{StaticResource FontSizeCaption}"
                                           IsVisible="{Binding ClientIdError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                            </StackPanel>
                            <StackPanel Spacing="2" Grid.Column="2" IsVisible="{Binding IsClientSecretVisible}">
                                <TextBlock Text="Client Secret" FontSize="{StaticResource FontSizeBody}" FontWeight="SemiBold" />
                                <TextBox Text="{Binding ClientSecret}"
                                         PasswordChar="â—"
                                         Watermark="Enter secret value"
                                         IsEnabled="{Binding !IsBusy}" />
                            </StackPanel>
                        </Grid>

                    </StackPanel>
                </suki:GlassCard>

                <!-- Action Buttons -->
                <StackPanel Spacing="8">
                    <Button Content="Connect"
                            Command="{Binding LoginCommand}"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            Background="{StaticResource PrimaryGradientBrush}"
                            Foreground="White"
                            Classes="Flat Large" />
                    
                    <Button Content="Save Profile"
                            Command="{Binding SaveProfileCommand}"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                            Classes="Basic" />
                </StackPanel>

                <!-- Device Code instructions -->
                <Border BorderBrush="{DynamicResource SystemControlForegroundAccentBrush}"
                        BorderThickness="1"
                        Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                        CornerRadius="{StaticResource RadiusLarge}" Padding="16"
                        IsVisible="{Binding IsDeviceCodeMessageVisible}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Enter this code at the sign-in page:"
                                   FontSize="{StaticResource FontSizeBody}"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource AppTextSecondaryBrush}" />

                        <!-- Large code display with copy button -->
                        <StackPanel Orientation="Horizontal" Spacing="12"
                                    HorizontalAlignment="Center">
                            <SelectableTextBlock Text="{Binding DeviceUserCode}"
                                                 FontSize="28" FontWeight="Bold"
                                                 FontFamily="Consolas, Courier New, monospace"
                                                 VerticalAlignment="Center"
                                                 LetterSpacing="4" />
                            <Button x:Name="CopyDeviceCodeButton"
                                    Content="Copy Code"
                                    Click="OnCopyDeviceCodeClick"
                                    VerticalAlignment="Center"
                                    Classes="Medium" />
                        </StackPanel>

                        <!-- Verification URL -->
                        <SelectableTextBlock Text="{Binding DeviceVerificationUrl}"
                                             FontSize="{StaticResource FontSizeBody}"
                                             HorizontalAlignment="Center"
                                             Foreground="{DynamicResource SystemControlForegroundAccentBrush}"
                                             FontFamily="Consolas, Courier New, monospace" />
                    </StackPanel>
                </Border>

                <!-- Status -->
                <TextBlock Text="{Binding StatusMessage}"
                           HorizontalAlignment="Center"
                           FontSize="{StaticResource FontSizeBody}"
                           Foreground="{DynamicResource AppTextSecondaryBrush}"
                           TextWrapping="Wrap"
                           IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />

                <!-- Loading indicator -->
                <ProgressBar IsIndeterminate="True"
                             IsVisible="{Binding IsBusy}"
                             Margin="0,4,0,0" />

                <!-- Error -->
                <Border Background="{DynamicResource AppErrorBackgroundBrush}" CornerRadius="{StaticResource RadiusSmall}" Padding="8"
                        IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="{Binding ErrorMessage}"
                               Foreground="{DynamicResource AppErrorTextBrush}"
                               TextWrapping="Wrap"
                               FontSize="{StaticResource FontSizeBody}" />
                </Border>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
