<suki:SukiWindow xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Intune.Commander.Desktop.ViewModels"
        xmlns:suki="https://github.com/kikipoulet/SukiUI"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        x:Class="Intune.Commander.Desktop.Views.GroupLookupWindow"
        x:DataType="vm:GroupLookupViewModel"
        Title="Group Assignment Lookup"
        Width="1000" Height="700"
        MinWidth="750" MinHeight="500"
        WindowStartupLocation="CenterOwner">

    <DockPanel Margin="16">

        <!-- Top: Search bar -->
        <DockPanel DockPanel.Dock="Top" Margin="0,0,0,12">
            <Button DockPanel.Dock="Right" Content="Search"
                    Command="{Binding SearchGroupsCommand}"
                    IsEnabled="{Binding !IsSearching}"
                    Margin="8,0,0,0"
                    Classes="Large"
                    HorizontalContentAlignment="Center" />
            <TextBox Text="{Binding SearchQuery}"
                     Watermark="Enter Entra group name or GUID..."
                     KeyDown="OnSearchKeyDown"
                     FontSize="{StaticResource FontSizeSubheading}" Padding="8" />
        </DockPanel>

        <!-- Status bar -->
        <DockPanel DockPanel.Dock="Bottom" Margin="0,8,0,0">
            <TextBlock Text="{Binding StatusText}" FontSize="{StaticResource FontSizeBody}"
                       VerticalAlignment="Center" Opacity="0.7" />
            <ProgressBar IsIndeterminate="True"
                         IsVisible="{Binding IsBusy}"
                         Width="180" Height="10"
                         Foreground="{DynamicResource ProgressBarForegroundBrush}" Background="{DynamicResource ProgressBarBackgroundBrush}"
                         HorizontalAlignment="Right" VerticalAlignment="Center"
                         CornerRadius="5" />
        </DockPanel>

        <!-- Error message -->
        <Border DockPanel.Dock="Bottom"
                IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Background="{DynamicResource AppErrorBackgroundBrush}" CornerRadius="{StaticResource RadiusSmall}" Padding="8" Margin="0,4,0,0">
            <TextBlock Text="{Binding ErrorMessage}" Foreground="{DynamicResource AppErrorTextBrush}" FontSize="{StaticResource FontSizeBody}" TextWrapping="Wrap" />
        </Border>

        <!-- Group search results (shown when multiple results, hidden after selection loads) -->
        <Border DockPanel.Dock="Top"
                IsVisible="{Binding SearchResults.Count}"
                MaxHeight="180" Margin="0,0,0,8">
            <DockPanel>
                <TextBlock DockPanel.Dock="Top" Text="Select a group:" FontSize="{StaticResource FontSizeBody}"
                           FontWeight="SemiBold" Margin="0,0,0,4" />
                <ListBox ItemsSource="{Binding SearchResults}"
                         SelectedItem="{Binding SelectedGroup}"
                         MaxHeight="150" ScrollViewer.VerticalScrollBarVisibility="Auto">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="12" Margin="4,2">
                                <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold"
                                           VerticalAlignment="Center" />
                                <TextBlock Text="{Binding Description}" Opacity="0.6"
                                           VerticalAlignment="Center" MaxWidth="300"
                                           TextTrimming="CharacterEllipsis" />
                                <TextBlock Text="{Binding Id}" Opacity="0.4" FontSize="{StaticResource FontSizeCaption}"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </DockPanel>
        </Border>

        <!-- Selected group info banner -->
        <Border DockPanel.Dock="Top"
                IsVisible="{Binding SelectedGroupInfo, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                CornerRadius="{StaticResource RadiusSmall}" Padding="10,6" Margin="0,0,0,8">
            <DockPanel>
                <TextBlock Text="ðŸ”" FontSize="16" VerticalAlignment="Center" Margin="0,0,8,0" />
                <TextBlock Text="{Binding SelectedGroupInfo}" FontSize="{StaticResource FontSizeBody}"
                           FontWeight="SemiBold" VerticalAlignment="Center" />
            </DockPanel>
        </Border>

        <!-- Summary counts -->
        <Border DockPanel.Dock="Top"
                IsVisible="{Binding ResultSummary, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Margin="0,0,0,8">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <Button Command="{Binding FilterByCategoryCommand}"
                        CommandParameter="Device Configuration"
                        x:Name="FilterConfigBtn"
                        Classes.accent="{Binding IsConfigFilterActive}"
                        Classes="Medium" CornerRadius="{StaticResource RadiusSmall}">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="âš™" FontSize="{StaticResource FontSizeSubheading}" VerticalAlignment="Center" />
                        <TextBlock FontSize="{StaticResource FontSizeBody}" VerticalAlignment="Center">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0} Configs">
                                    <Binding Path="ConfigCount" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Button>
                <Button Command="{Binding FilterByCategoryCommand}"
                        CommandParameter="Compliance Policy"
                        x:Name="FilterComplianceBtn"
                        Classes.accent="{Binding IsComplianceFilterActive}"
                        Classes="Medium" CornerRadius="{StaticResource RadiusSmall}">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="âœ“" FontSize="{StaticResource FontSizeSubheading}" VerticalAlignment="Center" />
                        <TextBlock FontSize="{StaticResource FontSizeBody}" VerticalAlignment="Center">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0} Compliance">
                                    <Binding Path="ComplianceCount" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Button>
                <Button Command="{Binding FilterByCategoryCommand}"
                        CommandParameter="Application"
                        x:Name="FilterAppBtn"
                        Classes.accent="{Binding IsAppFilterActive}"
                        Classes="Medium" CornerRadius="{StaticResource RadiusSmall}">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="ðŸ“¦" FontSize="{StaticResource FontSizeSubheading}" VerticalAlignment="Center" />
                        <TextBlock FontSize="{StaticResource FontSizeBody}" VerticalAlignment="Center">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0} Apps">
                                    <Binding Path="AppCount" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Button>
                <Button Command="{Binding FilterByCategoryCommand}"
                        x:Name="FilterAllBtn"
                        Classes.accent="{Binding IsAllFilterActive}"
                        Classes="Medium" CornerRadius="{StaticResource RadiusSmall}">
                    <TextBlock FontSize="{StaticResource FontSizeBody}" FontWeight="SemiBold" VerticalAlignment="Center">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="{}{0} Total">
                                <Binding Path="TotalCount" />
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </Button>
            </StackPanel>
        </Border>

        <!-- Results DataGrid -->
        <Panel>
            <DataGrid ItemsSource="{Binding FilteredAssignmentResults}"
                  IsReadOnly="True"
                  AutoGenerateColumns="False"
                  GridLinesVisibility="Horizontal"
                  CanUserSortColumns="True"
                  CanUserReorderColumns="True"
                  CanUserResizeColumns="True"
                  SelectionMode="Single"
                  FontSize="{StaticResource FontSizeBody}">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Category" Binding="{Binding Category}" Width="150" />
                <DataGridTextColumn Header="Display Name" Binding="{Binding DisplayName}" Width="*" />
                <DataGridTextColumn Header="Type" Binding="{Binding ObjectType}" Width="200" />
                <DataGridTextColumn Header="Platform" Binding="{Binding Platform}" Width="90" />
                <DataGridTextColumn Header="Intent" Binding="{Binding AssignmentIntent}" Width="90" />
                <DataGridCheckBoxColumn Header="Exclusion" Binding="{Binding IsExclusion}" Width="80" />
            </DataGrid.Columns>
        </DataGrid>
            <Border IsVisible="{Binding HasNoResults}"
                    VerticalAlignment="Center" HorizontalAlignment="Center"
                    Padding="24,16" CornerRadius="{StaticResource RadiusLarge}"
                    Background="{DynamicResource SystemControlBackgroundAltHighBrush}">
                <StackPanel Spacing="8" HorizontalAlignment="Center">
                    <TextBlock Text="ðŸ”" FontSize="32" HorizontalAlignment="Center" />
                    <TextBlock Text="No assignments found for this group"
                               FontSize="{StaticResource FontSizeSubheading}" FontWeight="SemiBold"
                               HorizontalAlignment="Center" />
                    <TextBlock Text="Try clearing the category filter or searching for a different group."
                               FontSize="{StaticResource FontSizeBody}" Foreground="{DynamicResource AppTextSecondaryBrush}"
                               HorizontalAlignment="Center" TextWrapping="Wrap" MaxWidth="320" />
                </StackPanel>
            </Border>
        </Panel>

    </DockPanel>
</suki:SukiWindow>
