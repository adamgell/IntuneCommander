<suki:SukiWindow xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Intune.Commander.Desktop.ViewModels"
        xmlns:conv="using:Intune.Commander.Desktop.Converters"
        xmlns:suki="https://github.com/kikipoulet/SukiUI"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="540" d:DesignHeight="640"
        x:Class="Intune.Commander.Desktop.Views.PermissionsWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Intune Commander — Permission Report"
        Width="540" Height="640"
        MinWidth="420" MinHeight="400"
        WindowStartupLocation="CenterOwner">

    <Design.DataContext>
        <vm:MainWindowViewModel />
    </Design.DataContext>

    <DockPanel>

        <!-- Header bar -->
        <Border DockPanel.Dock="Top"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                Padding="16,12">
            <StackPanel Spacing="4">
                <TextBlock Text="Graph API Permission Report"
                           FontSize="{StaticResource FontSizeSubheading}" FontWeight="SemiBold" />
                <TextBlock FontSize="{StaticResource FontSizeBody}"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           Text="Shows which permissions are present in the current access token." />
            </StackPanel>
        </Border>

        <!-- Not-connected placeholder -->
        <Border DockPanel.Dock="Top" Padding="16,12"
                IsVisible="{Binding LastPermissionCheckResult, Converter={x:Static ObjectConverters.IsNull}}">
            <TextBlock Text="Connect to a tenant to run a permission check."
                       FontSize="{StaticResource FontSizeBody}"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center" />
        </Border>

        <!-- Results (only when we have a result) -->
        <ScrollViewer VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      IsVisible="{Binding LastPermissionCheckResult, Converter={x:Static ObjectConverters.IsNotNull}}">
            <StackPanel Margin="16" Spacing="14">

                <!-- Summary pill row -->
                <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                    <!-- Granted / Total pill -->
                    <Border CornerRadius="12" Padding="12,5"
                            Background="{Binding LastPermissionCheckResult.AllPermissionsGranted,
                                         FallbackValue=Gray,
                                         Converter={x:Static conv:PermissionSummaryBrushConverter.Instance}}">
                        <TextBlock FontSize="{StaticResource FontSizeBody}" FontWeight="SemiBold" Foreground="White"
                                   Text="{Binding LastPermissionCheckResult,
                                          Converter={x:Static conv:PermissionSummaryTextConverter.Instance}}" />
                    </Border>

                    <!-- Claim source badge -->
                    <Border CornerRadius="8" Padding="8,4"
                            Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="Token type:" FontSize="{StaticResource FontSizeCaption}"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                       VerticalAlignment="Center" />
                            <TextBlock FontSize="{StaticResource FontSizeCaption}" FontWeight="SemiBold" VerticalAlignment="Center"
                                       Text="{Binding LastPermissionCheckResult.ClaimSource}" />
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Missing permissions -->
                <StackPanel Spacing="6"
                            IsVisible="{Binding LastPermissionCheckResult.MissingPermissions.Count,
                                        Converter={x:Static conv:CountGreaterThanZeroConverter.Instance}}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <Border Background="{DynamicResource ErrorBadgeBrush}" CornerRadius="{StaticResource RadiusSmall}" Padding="6,2">
                            <TextBlock Text="Missing" FontSize="{StaticResource FontSizeCaption}" FontWeight="SemiBold" Foreground="White" />
                        </Border>
                        <TextBlock FontSize="{StaticResource FontSizeBody}" VerticalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                   Text="These features will return 403 until the permission is granted." />
                    </StackPanel>
                    <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                            CornerRadius="6" Padding="10,8">
                        <ItemsControl ItemsSource="{Binding LastPermissionCheckResult.MissingPermissions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="x:String">
                                    <Border Padding="0,3">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="✗" Foreground="{DynamicResource ErrorBadgeBrush}"
                                                       FontSize="13" FontWeight="Bold"
                                                       VerticalAlignment="Center" />
                                            <SelectableTextBlock Text="{Binding}"
                                                        FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                                        FontSize="12"
                                                        VerticalAlignment="Center" />
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Border>
                </StackPanel>

                <!-- Granted permissions -->
                <StackPanel Spacing="6"
                            IsVisible="{Binding LastPermissionCheckResult.GrantedPermissions.Count,
                                        Converter={x:Static conv:CountGreaterThanZeroConverter.Instance}}">
                    <Border Background="{DynamicResource SuccessBadgeBrush}" CornerRadius="{StaticResource RadiusSmall}" Padding="6,2" HorizontalAlignment="Left">
                                <TextBlock Text="Granted" FontSize="{StaticResource FontSizeCaption}" FontWeight="SemiBold" Foreground="White" />
                    </Border>
                    <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                            CornerRadius="6" Padding="10,8">
                        <ItemsControl ItemsSource="{Binding LastPermissionCheckResult.GrantedPermissions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="x:String">
                                    <Border Padding="0,3">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="✓" Foreground="#00CC55"
                                                       FontSize="13" FontWeight="Bold"
                                                       VerticalAlignment="Center" />
                                            <SelectableTextBlock Text="{Binding}"
                                                        FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                                        FontSize="12"
                                                        VerticalAlignment="Center" />
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Border>
                </StackPanel>

                <!-- Extra permissions (collapsible) -->
                <Expander Header="Extra permissions in token (not required by this app)"
                          IsExpanded="False"
                          IsVisible="{Binding LastPermissionCheckResult.ExtraPermissions.Count,
                                      Converter={x:Static conv:CountGreaterThanZeroConverter.Instance}}">
                    <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                            CornerRadius="6" Padding="10,8" Margin="0,4,0,0">
                        <ItemsControl ItemsSource="{Binding LastPermissionCheckResult.ExtraPermissions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="x:String">
                                    <SelectableTextBlock Text="{Binding}"
                                                FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                                FontSize="12" Padding="0,2" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Border>
                </Expander>

            </StackPanel>
        </ScrollViewer>

    </DockPanel>
</suki:SukiWindow>
